# .github/workflows/update-ala-data.yml
# -------------------------------------
# Weekly job that refreshes Toohey Forest ALA records every Thurs,
# commits the updated .rds file + log files, and pushes
# them back to the main branch.

name: Update ALA data

on:
  schedule:
    - cron: '10 14 * * Wed'     # Wed 14:10 UTC  → Thu 00:10 AEST
  workflow_dispatch:

jobs:
  update-ALA-data:
    runs-on: ubuntu-24.04        # explicit image

    env:
      RENV_PATHS_CACHE: ${{ github.workspace }}/.renv

    steps:
      # 0 ───────────────────────────────────────────
      - name: Check out repository
        uses: actions/checkout@v4

      # 1 ───────────────────────────────────────────
      - name: Set up R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: '4.5'
          use-public-rspm: true

      # 2 ───────────────────────────────────────────
      - name: Install system libraries
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends \
            libcurl4-openssl-dev \
            libssl-dev \
            libgit2-dev \
            libudunits2-dev \        # ← fixes the error
            libgdal-dev \
            libgeos-dev \
            libproj-dev

      # 3 ───────────────────────────────────────────
      - name: Restore renv library
        uses: r-lib/actions/setup-renv@v2
        with:
          cache-version: 2           # forces a clean cache the first run

      # 4 ───────────────────────────────────────────
      - name: Update ALA data
        run: Rscript -e 'source("R/get_ALA_data.R")'

      # 5 ───────────────────────────────────────────
      - name: Configure git identity
        run: |
          git config --global user.name  "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Commit and push results
        run: |
          git add output_data/toohey_species_occurrences.rds || true
          git add logs || true
          if ! git diff --cached --quiet; then
            git commit -m "Automated ALA data update"
            git push origin HEAD:main
          else
            echo "No changes to commit"
          fi
